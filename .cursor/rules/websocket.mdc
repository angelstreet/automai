---
description: WebSocket & Terminal Implementation Guidelines
globs: src/lib/websocket-server.ts, websocket.server.js, src/components/virtualization/**/*.tsx
---

# WebSocket & Terminal Implementation Guidelines

## WebSocket Architecture Overview

The project uses a dual WebSocket implementation:

1. **Standalone WebSocket Server** (`websocket.server.js`)
   - Located at the root of the project
   - Runs on port 3001 (separate from Next.js HTTP server)
   - Handles terminal connections for SSH
   - Started independently from the Next.js server

2. **WebSocket Utility Module** (`src/lib/websocket-server.ts`)
   - Provides utility functions for WebSocket connections
   - Used within the Next.js application
   - Exports functions like `getWebSocketServer()` and `handleUpgrade()`

## Standalone WebSocket Server (websocket.server.js)

1. **Initialization**
   - Server is initialized on first terminal connection
   - Listens on port 3001
   - Handles WebSocket upgrade requests for terminal paths

2. **Connection Management**
   - Implements ping/pong for connection health monitoring
   - Terminates connections that don't respond to pings
   - Cleans up resources when connections close

3. **SSH Integration**
   - Uses ssh2 library for SSH connections
   - Handles host authentication and terminal sessions
   - Streams data between SSH and WebSocket clients

## WebSocket Utility Module (src/lib/websocket-server.ts)

1. **Singleton Pattern**
   - **IMPORTANT**: Always use the global WebSocketServer instance
   - Never create new WebSocketServer instances in route handlers
   - Use `getWebSocketServer()` to access the singleton instance
   - Handle WebSocket upgrades through the `handleUpgrade()` utility function

2. **Connection Management**
   - Implement ping/pong for connection health monitoring
   - Set `isAlive` flag to true on connection and on pong events
   - Terminate connections that don't respond to pings
   - Clean up resources when connections close

3. **Error Handling**
   - Always wrap WebSocket operations in try/catch blocks
   - Log errors with appropriate action tags
   - Send error messages to clients in JSON format
   - Include proper status codes in error responses

## Terminal Implementation
1. **xterm.js Integration**
   - Use xterm.js for terminal UI in the browser
   - Configure with appropriate options for performance
   - Handle terminal resize events
   - Support copy/paste operations

2. **SSH Connection**
   - Use ssh2 library for SSH connections
   - Implement proper authentication flow
   - Handle fingerprint verification
   - Stream data between SSH and WebSocket

3. **Security Considerations**
   - Validate user permissions before establishing connections
   - Implement timeouts for authentication
   - Close idle connections after a period of inactivity
   - Sanitize input/output to prevent injection attacks

## WebSocket API Routes
1. **Route Configuration**
   - Set `bodyParser: false` in the route config
   - Check for 'upgrade' header in the request
   - Return appropriate status codes for WebSocket responses

2. **Connection Establishment**
   - Follow this pattern for WebSocket setup:
   ```typescript
   // Set up WebSocket connection
   const { clientSocket, response } = await setupWebSocket(request, id);
   
   // Set up authentication timeout
   setupAuthTimeout(clientSocket, id);
   
   // Handle the specific connection type
   if (connection.type === 'ssh') {
     handleSshConnection(clientSocket, connection, id);
   } else {
     handleMockTerminal(clientSocket, connection, id);
   }
   
   return response;
   ```

3. **Message Handling**
   - Parse incoming messages as JSON when appropriate
   - Handle different message types (auth, resize, data)
   - Send structured responses to the client

## Frontend Integration
1. **WebSocket Client**
   - Create WebSocket connections with appropriate URL
   - Implement reconnection logic
   - Handle connection state changes
   - Process binary and text messages appropriately

2. **Terminal UI**
   - Initialize xterm.js with proper configuration
   - Attach WebSocket data handlers
   - Implement terminal resize logic
   - Support keyboard input and special keys

3. **User Experience**
   - Show connection status to users
   - Provide clear error messages
   - Implement loading states during connection
   - Support terminal customization (colors, font size)

## Testing WebSocket Connections
1. **Manual Testing**
   - Use browser developer tools to inspect WebSocket traffic
   - Test reconnection scenarios
   - Verify terminal functionality with various commands
   - Check error handling and recovery

2. **Automated Testing**
   - Mock WebSocket connections in tests
   - Verify correct message handling
   - Test error scenarios and recovery
   - Ensure proper cleanup of resources 