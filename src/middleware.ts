//DO NOT EDIT THIS FILE
import { NextRequest, NextResponse } from 'next/server';

import { updateSession } from '@/lib/supabase/middleware';
import { createClient } from '@/lib/supabase/middleware';

import { locales, defaultLocale } from './config';

// Lazy-loaded intl middleware
let intlMiddleware: any = null;
async function getIntlMiddleware() {
  if (!intlMiddleware) {
    const { default: createIntlMiddleware } = await import('next-intl/middleware');
    intlMiddleware = createIntlMiddleware({
      locales,
      defaultLocale,
      localePrefix: 'always',
    });
  }
  return intlMiddleware;
}

// Public paths (no auth required)
const PUBLIC_PATHS = [
  '/',
  '/features',
  '/pricing',
  '/docs',
  '/signup',
  '/auth-redirect',
  '/forgot-password',
  '/reset-password',
];

// Handle login redirects for authenticated users
async function handleLoginPath(request: NextRequest) {
  // Allow login with code parameter (for OAuth callbacks)
  if (request.nextUrl.searchParams.has('code') || request.nextUrl.searchParams.has('error')) {
    console.log(
      '[MIDDLEWARE] Bypassing auth check for login path with code/error param:',
      request.nextUrl.pathname,
    );
    return NextResponse.next();
  }

  // Check if user is authenticated and redirect to dashboard if they are
  const { supabase, response } = createClient(request);
  const { data } = await supabase.auth.getUser();

  if (data.user) {
    // User is authenticated, redirect to dashboard
    const locale = request.nextUrl.pathname.split('/')[1] || defaultLocale;
    const tenantName = data.user.user_metadata?.tenant_name || 'trial';
    console.log('[MIDDLEWARE] User already authenticated, redirecting from login to dashboard');
    return NextResponse.redirect(new URL(`/${locale}/${tenantName}/dashboard`, request.url));
  }

  // Not authenticated, allow access to login page
  return NextResponse.next();
}

export default async function middleware(request: NextRequest) {
  const path = request.nextUrl.pathname;

  // 1. Handle HTML content type bypass (from mw.ts)
  const contentType = request.headers.get('content-type') || '';
  const acceptHeader = request.headers.get('accept') || '';
  if (contentType.includes('text/html') || acceptHeader.includes('text/html')) {
    return NextResponse.next();
  }

  // Special handling for login path
  if (path === '/login' || path.endsWith('/login')) {
    return handleLoginPath(request);
  }

  // 2. Public paths: apply locale but RETURN EARLY
  if (PUBLIC_PATHS.some((p) => path === p || path === `/${defaultLocale}${p}`)) {
    // Special handling for root path to prevent double locale
    if (path === '/') {
      return NextResponse.redirect(new URL(`/${defaultLocale}`, request.url));
    }
    return NextResponse.next();
  }

  // Check for auth-redirect path with locale
  if (path.includes('/auth-redirect')) {
    console.log('[MIDDLEWARE] Bypassing auth check for auth-redirect path:', path);
    return NextResponse.next();
  }

  // 3. API routes: enforce auth
  if (path.startsWith('/api/')) {
    // API auth logic...
    return NextResponse.next();
  }

  // 4. Protected routes: enforce locale and auth
  const hasLocale = locales.some((locale) => path.startsWith(`/${locale}/`));
  if (!hasLocale) {
    return NextResponse.redirect(new URL(`/${defaultLocale}${path}`, request.url));
  }

  // 5. Update session and apply intl
  const response = await updateSession(request);
  const intl = await getIntlMiddleware();
  return intl(response);
}

export const config = {
  matcher: [
    '/((?!_next/static|_next/image|avatars|favicon.ico).*)',
    '/(fr|en)/:path*',
    '/api/:path*',
    '/',
  ],
};
